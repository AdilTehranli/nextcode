set(library_name "nextcodeCompatibility56")

include_directories("include/" "${NEXTCODE_STDLIB_SOURCE_DIR}")

add_compile_definitions(NEXTCODE_COMPATIBILITY56)
add_nextcode_target_library("${library_name}" STATIC
  Overrides.cpp
  Concurrency/Task.cpp
  Concurrency/TaskLocal.cpp
  Concurrency/TaskStatus.cpp
  Concurrency/Error.cpp
  Concurrency/Actor.cpp
  Concurrency/AsyncLet.cpp
  Concurrency/ThreadSanitizer.cpp
  Concurrency/TaskAlloc.cpp
  Concurrency/MutexPThread.cpp
  Runtime/Exclusivity.cpp

  TARGET_SDKS ${NEXTCODE_DARWIN_PLATFORMS}

  C_COMPILE_FLAGS
    ${CXX_COMPILE_FLAGS}
    "-D__STDC_WANT_LIB_EXT1__=1"
    "-DNEXTCODE_THREADING_IS_COMPATIBILITY_LIBRARY"
  LINK_FLAGS ${CXX_LINK_FLAGS}
  INCORPORATE_OBJECT_LIBRARIES nextcodeCompatibilityThreading
  NEXTCODE_COMPILE_FLAGS ${NEXTCODE_STANDARD_LIBRARY_NEXTCODE_FLAGS}
  DEPLOYMENT_VERSION_OSX ${COMPATIBILITY_MINIMUM_DEPLOYMENT_VERSION_OSX}
  DEPLOYMENT_VERSION_IOS ${COMPATIBILITY_MINIMUM_DEPLOYMENT_VERSION_IOS}
  DEPLOYMENT_VERSION_TVOS ${COMPATIBILITY_MINIMUM_DEPLOYMENT_VERSION_TVOS}
  DEPLOYMENT_VERSION_WATCHOS ${COMPATIBILITY_MINIMUM_DEPLOYMENT_VERSION_WATCHOS}
  DEPLOYMENT_VERSION_XROS ${COMPATIBILITY_MINIMUM_DEPLOYMENT_VERSION_XROS}

  MACCATALYST_BUILD_FLAVOR "zippered"

  INSTALL_IN_COMPONENT compiler
  INSTALL_WITH_SHARED)


# FIXME: We need a more flexible mechanism to add lipo targets generated by
# add_nextcode_target_library to the ALL target. Until then this hack is necessary
# to ensure these libraries build.
foreach(sdk ${NEXTCODE_SDKS})
  set(target_name "${library_name}-${NEXTCODE_SDK_${sdk}_LIB_SUBDIR}")
  if(NOT TARGET "${target_name}")
    continue()
  endif()

  set_target_properties("${target_name}"
    PROPERTIES
      EXCLUDE_FROM_ALL FALSE)
endforeach()
